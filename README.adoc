= OCP GitOps Demo (Air-Gapped)

Ce dépôt décrit une démonstration GitOps d'une application Node.js/Express + PostgreSQL
sur OpenShift 4.18 en environnement déconnecté. Tous les manifestes (application,
GitOps, CI Tekton, scripts) sont versionnés afin de pouvoir :

* bâtir les images applicatives dans un registre miroir interne ;
* déployer et scaler l'application via Argo CD ;
* tracer les artefacts grâce à Tekton Chains et aux signatures cosign.

== Structure du dépôt

[listing]
----
app/            Code Node.js/Express et scripts SQL
manifests/      Manifestes Kubernetes/OpenShift (base + overlays airgap)
argocd/         Définitions Argo CD (Application, AppProject, bootstrap)
tekton/         Pipelines, Tasks et PipelineRuns Tekton
scripts/        Outils auxiliaires (ex: génération secret cosign)
docs/           Documentation détaillée (airgap, CI/CD, opérations)
----

== Aperçu rapide

|===
| Composant | Détails

| Application
| Node.js/Express (3 pods) + PostgreSQL 15 (StatefulSet 1 réplique, PVC RWX ceph-fs)

| Déploiement
| Kustomize (`manifests/base` + overlay `manifests/overlays/airgap`) géré par Argo CD

| CI/CD
| Pipeline Tekton (tests → build/push → signature cosign → sync Argo) + Tekton Chains

| Air-gap
| Images mirroirées dans `harbor.skyr.dca.scc`, secrets registry + cosign dans `gitops-demo`
|===

== Prérequis

* OpenShift 4.18 avec OpenShift GitOps (Argo CD) et OpenShift Pipelines (Tekton)
* Accès au registre miroir `harbor.skyr.dca.scc` (secret `registry-credentials`)
* Accès au dépôt Git `https://bastion.skyr.dca.scc:3000/demoscc/OCP_GITOPS.git`
* CLI : `oc`, `cosign`, `kustomize`/`kubectl kustomize`
* Droits pour créer les namespaces `gitops-demo` et `openshift-gitops`

== Workflow général

. Builder/pusher les images dans le registre airgap (Pipeline Tekton ou build manuel)
. Générer la paire de clés cosign et le secret OpenShift (`scripts/gen-cosign-secret.sh`)
. Déployer les manifestes Kustomize via Argo CD (`argocd/application.yaml`)
. Lancer la Pipeline Tekton (tests, build, signature, push, sync Argo)
. Vérifier la Route exposée pour la page « Derniers clients »

== Guide étape par étape

=== Étape 0 — Préparer le cluster

. Installer les opérateurs *OpenShift GitOps* et *OpenShift Pipelines* via OperatorHub.
. Vérifier les namespaces `openshift-gitops` et `openshift-pipelines`.
. Créer (ou réutiliser) le namespace applicatif :

[source,powershell]
----
oc new-project gitops-demo
----

=== Étape 1 — Déployer le squelette GitOps

[source,powershell]
----
oc apply -f argocd/appproject.yaml
oc apply -f argocd/application.yaml
----

TIP: Ajustez `spec.source.repoURL` et `targetRevision` si vous utilisez un fork ou une autre branche.

=== Étape 2 — Secrets registry et cosign

. Modifier `tekton/secret-registry.yaml` avec vos identifiants réels puis appliquer :
+
[source,bash]
----
oc apply -f tekton/secret-registry.yaml -n gitops-demo
oc apply -f tekton/secret-git-credentials.yaml -n gitops-demo
----
. Générer la paire cosign et créer/mettre à jour le secret `cosign-key` dans `openshift-gitops` :
+
[source,bash]
----
bash scripts/gen-cosign-secret.sh
----

=== Étape 3 — Chaîne CI Tekton

. Appliquer la configuration Tekton Chains :
+
[source,bash]
----
oc apply -f tekton/chains-config.yaml -n openshift-pipelines
----
. Déployer la ServiceAccount et les Tasks :
+
[source,bash]
----
oc apply -f tekton/serviceaccount.yaml -n gitops-demo
oc apply -f tekton/task-tests.yaml -n gitops-demo
oc apply -f tekton/task-build.yaml -n gitops-demo
oc apply -f tekton/task-argocd-sync.yaml -n gitops-demo
oc apply -f tekton/pipeline.yaml -n gitops-demo
----
. Créer le secret `argocd-token` avec un token valide :
+
[source,bash]
----
oc create secret generic argocd-token -n gitops-demo \
  --from-literal=token=$(argocd account generate-token --account demo)
----

=== Étape 4 — Lancer et suivre le PipelineRun

[source,bash]
----
oc create -f tekton/pipelinerun.yaml -n gitops-demo
tkn pipelinerun logs -f -n gitops-demo $(tkn pipelinerun ls -n gitops-demo -o name | head -n1)
----

=== Étape 5 — Valider la livraison

[source,powershell]
----
oc get pods -n gitops-demo
oc get application customer-stack -n openshift-gitops -o jsonpath='{.status.sync.status}'
$ROUTE = oc get route customer-web -n gitops-demo -o jsonpath='{.spec.host}'
curl -k https://$ROUTE | head
----

=== Étape 6 — Nettoyer (optionnel)

[source,bash]
----
oc delete -f tekton/pipelinerun.yaml -n gitops-demo --ignore-not-found
oc delete project gitops-demo
oc delete application customer-stack -n openshift-gitops --ignore-not-found
oc delete appproject gitops-demo -n openshift-gitops --ignore-not-found
----

== Dépannage rapide

* *Build Tekton en échec* : vérifier le secret `registry-credentials` et éventuellement passer `TLSVERIFY=false`.
* *Signatures absentes* : s'assurer que `cosign-key` est monté sur `pipeline-gitops` et que `tekton/chains-config.yaml` pointe vers un dépôt OCI accessible.
* *Argo CD OutOfSync* : contrôler la connectivité Git (`argocd app get customer-stack`) puis forcer `argocd app sync customer-stack`.
* *Argo CD SyncFailed (forbidden)* : vérifier que `manifests/base/rolebinding-argocd-controller.yaml` lie le ClusterRole `edit` au SA `openshift-gitops-argocd-application-controller` dans `gitops-demo`.
* *Erreur certificat Git (x509)* : si le serveur Git possède un certificat auto-signé, insérer `insecure: true` sous `spec.source` dans `argocd/application.yaml` (déjà présent pour `bastion.skyr.dca.scc:3000`).
* *Job `seed-customers` en erreur* : patienter jusqu'à ce que PostgreSQL soit `Ready` et examiner `oc logs job/seed-customers`.

== Démarrage rapide

=== 1. Préparer l'environnement GitOps

[source,powershell]
----
oc new-project gitops-demo
oc apply -f argocd/appproject.yaml
oc apply -f argocd/application.yaml
----

TIP: Si vous utilisez un compte non-admin (`demoscc`), demandez à un administrateur d'exécuter :

[source,bash]
----
chmod +x scripts/apply-argocd-rbac.sh
ARGOCD_USER=demoscc bash scripts/apply-argocd-rbac.sh
----

Le script applique les manifests RBAC (`argocd/role-argo-admin.yaml`, `argocd/rolebinding-argo-admin.yaml`, `argocd/clusterrole-argo-admin.yaml`, `argocd/clusterrolebinding-argo-admin.yaml`, `argocd/rolebinding-namespace-access.yaml` pour exposer le `ClusterRole` `view` et autoriser `oc project openshift-gitops`) puis vérifie les droits via `oc auth can-i --as=demoscc`. Ajustez `ARGOCD_USER`/`ARGOCD_NAMESPACE` selon votre contexte.

=== 2. Secrets registry + cosign

[source,bash]
----
oc apply -f tekton/secret-registry.yaml -n gitops-demo
bash scripts/gen-cosign-secret.sh
----

=== 3. Configurer Tekton Chains

[source,bash]
----
oc apply -f tekton/chains-config.yaml -n openshift-pipelines
----

=== 4. Installer les ressources Tekton

[source,bash]
----
oc apply -f tekton/serviceaccount.yaml -n gitops-demo
oc apply -f tekton/task-tests.yaml -n gitops-demo
oc apply -f tekton/task-build.yaml -n gitops-demo
oc apply -f tekton/task-argocd-sync.yaml -n gitops-demo
oc apply -f tekton/pipeline.yaml -n gitops-demo
oc apply -f tekton/secret-argocd-token.yaml -n gitops-demo
----

=== 5. Lancer un PipelineRun

[source,bash]
----
oc create -f tekton/pipelinerun.yaml -n gitops-demo
----

Pipeline : clone du dépôt → `npm test` → build/push image web → build/push image init → signature cosign → sync Argo CD.

=== 6. Vérifier la Route

[source,bash]
----
oc get route customer-web -n gitops-demo -o jsonpath='{.spec.host}'
----

== Tests locaux

[source,bash]
----
cd app
npm install
npm test
----

== Notes air-gap

* Adapter `harbor.skyr.dca.scc` et les tags dans `manifests/base/kustomization.yaml`.
* Veiller à mirrorer toutes les images Red Hat (UBI, Node.js, Buildah, PostgreSQL).
* Mettre à jour `tekton/secret-argocd-token.yaml` avec un token réel (`argocd account generate-token`).

=== Sources d'images (source 1 / source 2)

|===
| Composant | Source 1 (amont) | Source 2 (airgap)

| Application web
| `build-local (podman build ./app)`
| `harbor.skyr.dca.scc/gitops/customer-web:0.1.0`

| Job init PostgreSQL
| `build-local (podman build ./app/db)`
| `harbor.skyr.dca.scc/gitops/customer-db-init:0.1.0`

| Serveur PostgreSQL
| `registry.redhat.io/rhel9/postgresql-15:latest`
| `harbor.skyr.dca.scc/gitops/postgresql-15:latest`

| Base Node.js (tests Tekton)
| `registry.access.redhat.com/ubi9/nodejs-18:latest`
| `harbor.skyr.dca.scc/gitops/nodejs-18:latest`

| Buildah (Task build)
| `registry.redhat.io/rhel8/buildah:latest`
| `harbor.skyr.dca.scc/gitops/buildah:latest`

| CLI Argo CD
| `quay.io/argoproj/argocd:v2.13.3`
| `harbor.skyr.dca.scc/gitops/argocd:v2.13.3`
|===

== Préparation du registre Harbor

=== 1. Créer les projets

[source,bash]
----
export HARBOR_URL="https://harbor.skyr.dca.scc"
export HARBOR_USER="admin"
export HARBOR_PASS="********"

for project in gitops rhel9 ubi9 rhel8 openshift4; do
  curl -k -u "${HARBOR_USER}:${HARBOR_PASS}" \
    -H "Content-Type: application/json" \
    -X POST "${HARBOR_URL}/api/v2.0/projects" \
    -d "{\"project_name\":\"${project}\",\"public\":false}" \
    || echo "Projet ${project} déjà créé";
done
----

=== 2. (Optionnel) créer un compte robot pour Tekton

[source,bash]
----
curl -k -u "${HARBOR_USER}:${HARBOR_PASS}" \
  -H "Content-Type: application/json" \
  -X POST "${HARBOR_URL}/api/v2.0/projects/gitops/robots" \
  -d '{"name":"tekton","access":[{"resource":"repository","action":"push","effect":"allow"},{"resource":"repository","action":"pull","effect":"allow"}]}'
----

Le mot de passe renvoyé est à renseigner dans `tekton/secret-registry.yaml`.

=== 3. Mirrorer les images nécessaires

[source,bash]
----
# Builder et pousser les images applicatives à partir de ce dépôt
podman build -t harbor.skyr.dca.scc/gitops/customer-web:0.1.0 app
podman push harbor.skyr.dca.scc/gitops/customer-web:0.1.0
podman build -t harbor.skyr.dca.scc/gitops/customer-db-init:0.1.0 app/db
podman push harbor.skyr.dca.scc/gitops/customer-db-init:0.1.0

# Mirrorer les images Red Hat requises
skopeo copy --all docker://registry.redhat.io/rhel9/postgresql-15:latest \
  docker://harbor.skyr.dca.scc/gitops/postgresql-15:latest
skopeo copy --all docker://registry.access.redhat.com/ubi9/nodejs-18:latest \
  docker://harbor.skyr.dca.scc/gitops/nodejs-18:latest
skopeo copy --all docker://registry.redhat.io/rhel8/buildah:latest \
  docker://harbor.skyr.dca.scc/gitops/buildah:latest
skopeo copy --all docker://quay.io/argoproj/argocd:v2.13.3 \
  docker://harbor.skyr.dca.scc/gitops/argocd:v2.13.3
----

Pré-créez également un dépôt vide `gitops/signatures` (il sera alimenté par Tekton Chains).
